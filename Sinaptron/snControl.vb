Imports GMap.NET.WindowsForms

Public Class snControl
    Dim Latitude As Double
    Dim Longitude As Double
    Dim Markers As GMapOverlay
    Dim SnCreate As Boolean = False
    Dim RemoveLast As Integer
    Dim nodoid As String

    Dim comando As New comandos()

    Dim VarCalVolt As Integer = 151

    'permiten hacer las consultas de varias tramas
    Dim Flag1 As Boolean
    Dim Flag2 As Boolean
    Dim Flag3 As Boolean

    Dim LimitTime As Integer = 15 ' evita que al enviar los comandos de consulta no se quede en bucle infinito


    'Sub New(ByVal lat As Double, ByVal longt As Double, ByVal mark As GMapOverlay, ByVal create As Boolean)
    'Sub New(ByVal lat As Double, ByVal longt As Double, ByVal mark As GMapOverlay, ByVal create As Boolean, ByVal value As Integer, ByVal nodoid As String)
    Sub New(ByVal lat As Double, ByVal longt As Double, ByVal mark As GMapOverlay, ByVal create As Boolean, ByVal value As Integer, ByVal id As String)
        ' Esta llamada es exigida por el diseñador.
        InitializeComponent()

        Latitude = lat
        Longitude = longt
        Markers = mark
        SnCreate = create

        txtLat.Text = Latitude
        txtLong.Text = Longitude
        RemoveLast = value

        nodoid = id

    End Sub
    Private Sub CrearSinap_Click(sender As Object, e As EventArgs) Handles CrearSinap.Click
        MapaTab.GMapControl1.Enabled = True
        If txtSnX.Text <> "" And txtSnY.Text <> "" And txtDir.Text <> "" And txtCall.Text <> "" And txtCarr.Text <> "" Then
            'Evita que se registren dos sinaptrones iguales
            If Nodo.VerificacionSn(txtSnX.Text, txtSnY.Text) = True Then
                Nodo.Guardar(txtSnX.Text, txtSnY.Text, txtLat.Text, txtLong.Text, txtDir.Text, txtCall.Text, txtCarr.Text)
                SnCreate = True
                Me.Close()
            Else
                MsgBox("El sinpatron no se a podido crear porque ya existe ")
            End If

        Else
            MsgBox("Se deben llenar todos los campos")
        End If
    End Sub

    Private Sub btnEditar_Click(sender As Object, e As EventArgs) Handles btnEditar.Click
        MapaTab.GMapControl1.Enabled = True
        Nodo.Editar(txtRef.Text, txtSnX.Text, txtSnY.Text, txtDir.Text, txtCall.Text, txtCarr.Text)
        Me.Close()
    End Sub

    Private Sub EliminarSinap_Click(sender As Object, e As EventArgs) Handles EliminarSinap.Click
        MapaTab.GMapControl1.Enabled = True
        If SnCreate = True Then
            Nodo.Eliminar(txtRef.Text)
            MapaTab.GMapControl1.Enabled = True
            MapaTab.GMapControl1.Overlays.Remove(Markers)
            MapaTab.GMapControl1.Refresh()
            Me.Close()
        End If
    End Sub

    Private Sub btnCloseForm_Click(sender As Object, e As EventArgs) Handles btnCloseForm.Click
        MapaTab.GMapControl1.Enabled = True
        Me.Close()
        If SnCreate = False Then
            'SnPrincipal.GMapControl1.Overlays.Remove(Markers)
            MapaTab.GMapControl1.Overlays.Last().Clear()

            'Markers.Clear()
            MapaTab.GMapControl1.Refresh()

            Console.WriteLine("hola")
        End If
    End Sub

    Private Sub ReiniciarFlags(tiempo As Integer)
        'Reinicia los valores 
        Flag1 = True
        Flag2 = False
        Flag3 = False

        LimitTime = tiempo
    End Sub



    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    'SEMAFOROS
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '//////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    Private Sub btnPrender_Click(sender As Object, e As EventArgs) Handles btnPrender.Click
        comando.Prender(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    Private Sub btnApagar_Click(sender As Object, e As EventArgs) Handles btnApagar.Click
        comando.Apagar(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    'INTERMITENCIA
    Private Sub btnPrecaucion_Click(sender As Object, e As EventArgs) Handles btnPrecaucion.Click
        comando.PrecaucionRoja(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    Private Sub btnPrecaucion2_Click(sender As Object, e As EventArgs) Handles btnPrecaucion2.Click
        comando.PrecaucionAmarilla(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    'Luces
    Private Sub nudLight_ValueChanged(sender As Object, e As EventArgs) Handles nudLight.ValueChanged
        comando.Luz(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"), Hex(Val(nudLight.Text)).ToString.PadLeft(2, "0"))
    End Sub

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    'ENVIAR TIEMPOS
    Private Sub btnSendRed_Click(sender As Object, e As EventArgs) Handles btnSendRed.Click
        comando.Rojo(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtRed.Text)).ToString.PadLeft(2, "0"))
    End Sub

    Private Sub btnSendAmbar_Click(sender As Object, e As EventArgs) Handles btnSendAmbar.Click
        comando.Amarillo(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtAmbar.Text)).ToString.PadLeft(2, "0"))
    End Sub

    Private Sub btnSendGreen_Click(sender As Object, e As EventArgs) Handles btnSendGreen.Click
        comando.Verde(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtGreen.Text)).ToString.PadLeft(2, "0"))
    End Sub


    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    'SECCION DE ENTRADAS Y SALIDAS
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    Private Sub btnTryOut_Click(sender As Object, e As EventArgs) Handles btnTryOut.Click
        comando.ProbarOpticas(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    Private Sub btnTryIn_Click(sender As Object, e As EventArgs) Handles btnTryIn.Click
        comando.ProbarSensores(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    Private Sub btnOffTest_Click(sender As Object, e As EventArgs) Handles btnOffTest.Click
        comando.ApagarPruebaSensores(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    'CONSULTAS
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    'CONSULTAR TIEMPOS
    Private Sub btnTiempoRojo_Click(sender As Object, e As EventArgs) Handles btnTiempoRojo.Click
        comando.ConsultarRojo(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    Private Sub btnTiempoAmarillo_Click(sender As Object, e As EventArgs) Handles btnTiempoAmarillo.Click
        comando.ConsultarAmarillo(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    Private Sub btnTiempoVerde_Click(sender As Object, e As EventArgs) Handles btnTiempoVerde.Click
        comando.ConsultarVerde(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
    End Sub

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    'Clasifica la información de acuerdo  al CM 
    Private Sub ClasificarCM(snFormat)

        'CONSULTAS
        'Batería
        If snFormat.CM = "81" Then

            If Flag1 = True Then
                txtSnX.Text = CInt("&H" & snFormat.X2)
                txtSnY.Text = CInt("&H" & snFormat.Y2)

                txtNVBatt.Text = Format((snFormat.D0 * 10) / VarCalVolt, "0.00")
                Flag1 = False
                Flag2 = True
            ElseIf Flag2 = True Then
                txtNVPanel.Text = Format((snFormat.D0 * 10) / VarCalVolt, "0.00")
                Flag2 = False
                Flag3 = True
            ElseIf Flag3 = True Then
                txtStatusE.Text = snFormat.D0
                Flag3 = False
            End If

        End If
        'Tiempos 
        If snFormat.CM = "B4" And snFormat.A1 = "23" And snFormat.A0 = "FF" Then
            If Flag1 = True Then

                'txtRed.Text = snFormat.D0
                ' If FlagConsultaMapa = False Then
                txtRed.Text = snFormat.D0
                'Else
                'txtRedMap.Text = snFormat.D0
                'End If
                Flag1 = False
                ' Flag5 = True
            ElseIf Flag2 = True Then

                'txtAmbar.Text = snFormat.D0
                'If FlagConsultaMapa = False Then
                txtAmbar.Text = snFormat.D0
                'Else
                '   txtAmbarMap.Text = snFormat.D0
                'End If
                Flag2 = False
                'Flag6 = True
            ElseIf Flag3 = True Then

                'txtGreen.Text = snFormat.D0
                ' If FlagConsultaMapa = False Then
                txtGreen.Text = snFormat.D0
                ' Else
                'txtGreenMap.Text = snFormat.D0
                'End If
                Flag3 = False
            End If
            ''//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            ''//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
            ''//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        End If

    End Sub

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    'BATERIA CONSULTAR

    Private Sub btnBateriaConsulta_Click(sender As Object, e As EventArgs) Handles btnBateriaConsulta.Click
        ReiniciarFlags(20)
        'SnPrincipal.clasificarConsul.Seccion = False
        tmrBatt.Enabled = False
        tmrBatt.Enabled = True
    End Sub

    Private Sub tmrBatt_Tick(sender As Object, e As EventArgs) Handles tmrBatt.Tick
        If LimitTime > 0 Then
            If Flag1 = True Then
                'Batería
                comando.ConsultarBateria(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
            ElseIf Flag2 = True Then
                'Panel
                comando.ConsultarPanel(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
            ElseIf Flag3 = True Then
                'Estado de energia
                comando.ConsultarEnergia(Hex(Val(txtSnX.Text)).ToString.PadLeft(2, "0"), Hex(Val(txtSnY.Text)).ToString.PadLeft(2, "0"))
            Else
                tmrBatt.Enabled = False
            End If
        Else
            tmrBatt.Enabled = False
        End If

        LimitTime -= 1
    End Sub


End Class