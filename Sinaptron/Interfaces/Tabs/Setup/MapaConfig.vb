Imports GMap.NET
Imports GMap.NET.MapProviders
Imports GMap.NET.WindowsForms
Imports GMap.NET.WindowsForms.Markers

Public Class MapaConfig
    Dim MarkersCount As Integer = -1
    Public point As PointLatLng


    Private Sub MapaConfig_Load(sender As Object, e As EventArgs) Handles MyBase.Load

        'Geo Referencia  inicial en este caso Medellín
        GMapControl1.DragButton = MouseButtons.Left
        GMapControl1.MapProvider = GMapProviders.GoogleMap
        GMapControl1.Position = New GMap.NET.PointLatLng(6.242731, -75.56584)
        GMapControl1.MinZoom = 12.9
        GMapControl1.MaxZoom = 18
        GMapControl1.Zoom = 12.9

        'Quita el indicador del centro
        GMapControl1.ShowCenter = False
    End Sub

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    '///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


    Private Async Function ConsultarTodo() As Task
        Dim result = Nodo.ConsultarTodo()
        For Each item In result
            MarkersCount += 1
            GMapControl1.Refresh()
            GMapControl1.MapProvider = GMapProviders.GoogleMap
            GMapControl1.Position = New PointLatLng(item.Item(4), item.Item(5))

            Dim Point As New PointLatLng(item.Item(4), item.Item(5))
            CreateMarker(Point, item.Item(1))
        Next
    End Function

    Function CreateMarker(point As PointLatLng, ref As String) As GMapOverlay
        'Creating a custom marker
        Dim bmpMarker As Bitmap
        bmpMarker = Image.FromFile("..\..\img\marker.png")
        'Adding Marker
        'Create a Overlay
        Dim markers As New GMapOverlay("markers")



        Dim marker As GMapMarker = New GMarkerGoogle(point, bmpMarker)
        marker.Tag = ref
        marker.ToolTipText = $"Latitude: {GMapControl1.Position.Lat},{vbLf} Longitude: {GMapControl1.Position.Lng}"
        'add all available markers to that Overlay
        markers.Markers.Add(marker)
        'markers.Control.Name = "s"
        'Cover map with Overlay
        GMapControl1.Overlays.Add(markers)

        ' Console.WriteLine("son " & GMapControl1.Overlays.Count())
        ' RefreshMap()
        Return markers
    End Function

    Function RefreshMap()
        GMapControl1.Zoom = GMapControl1.Zoom - 1
        GMapControl1.Zoom = GMapControl1.Zoom + 1
    End Function

    Dim snControl2

    Private Sub GMapControl1_MouseDoubleClick(sender As Object, e As MouseEventArgs) Handles GMapControl1.MouseDoubleClick
        GMapControl1.Refresh()
        'Console.WriteLine(e.X & " " & e.Y)
        point = GMapControl1.FromLocalToLatLng(e.X, e.Y)

        Console.WriteLine(GMapControl1.Zoom)
        GMapControl1.MapProvider = GMapProviders.GoogleMap
        GMapControl1.Position = New PointLatLng(point.Lat, point.Lng)

        GMapControl1.Zoom = 18
        CreateMarker(point, "")

        Label2.Text = point.Lat

        RefreshMap()

        Ubicacion.Coordenadas(point.Lat, point.Lng)
    End Sub
End Class